name: CI/CD Pipeline
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted # KRİTİK NOKTA: İş senin PC'de dönecek
    steps:
    - name: Kodu Çek
      uses: actions/checkout@v3

    - name: Minikube Docker Ortamını Ayarla
      run: eval $(minikube docker-env)

    - name: Go Uygulamasını Build Et (v100)
      run: |
        eval $(minikube docker-env)
        docker build --no-cache -t serhatsdocker/go-app:v100 ./app

    - name: ML Ajanını Build Et
      run: |
        eval $(minikube docker-env)
        docker build --no-cache -t serhatsdocker/ml-agent:v1 ./ml

    - name: Kubernetes Deployment Güncelle
      run: |
        # YAML dosyalarını uygula
        kubectl apply -f k8s/app-deployment.yaml
        kubectl apply -f k8s/ml-deployment.yaml
        
        # Podları yeniden başlat (Güncel kodun aktif olması için)
        kubectl rollout restart deployment/app-deployment
        kubectl rollout restart deployment/ml-agent
