name: Deploy & Reset to v2

on:
  push:
    branches: [ "main" ]

jobs:
  setup-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Kodları İndir
        uses: actions/checkout@v4

      - name: Minikube Docker Ortamını Al
        run: eval $(minikube -p minikube docker-env)

      - name: 1. ML Modelini Eğit
        run: |
          cd ml
          pip install -r requirements.txt || true
          python train_model.py

      - name: 2. Image'ları Build Et
        run: |
          eval $(minikube -p minikube docker-env)
          docker build -t serhatsdocker/go-app:v4 ./app
          docker build -t serhatsdocker/chaos-app:v2 ./chaos
          docker build -t serhatsdocker/ml-agent:v1 ./ml

      - name: 3. Kubernetes'e Uygula (v2 Başlat)
        run: |
          kubectl apply -f k8s/rbac.yaml
          kubectl apply -f k8s/prometheus-config.yaml
          kubectl apply -f k8s/prometheus-deployment.yaml
          kubectl apply -f k8s/grafana-deployment.yaml
          kubectl apply -f k8s/chaos-deployment.yaml
          kubectl apply -f k8s/ml-deployment.yaml
          kubectl apply -f k8s/app-deployment.yaml

      - name: 4. Deployment'ı Zorla Resetle (v2'ye Dönsün)
        run: |
          kubectl rollout restart deployment/app-deployment
          echo "Sistem v2 olarak ayağa kalkıyor..."
          sleep 10
          kubectl get pods
